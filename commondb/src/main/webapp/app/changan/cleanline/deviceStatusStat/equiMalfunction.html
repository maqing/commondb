<!DOCTYPE html>
<html>
  <head>
      <meta charset="UTF-8"/>
      <title>后处理单元-设备故障统计</title>
      <link rel="stylesheet" href="/css/bootstrap.min.css">
      <link rel="stylesheet" href="/css/font-awesome.min.css">
      <link rel="stylesheet" href="/css/system.css">
      <style>
          body{
              overflow-y: auto;
          }
      </style>
      
      <script type="text/javascript" src="../_lib/jquery-1.11.1.min.js"></script>
      <script type="text/javascript" src="../_lib/system.js"></script>
      <script type="text/javascript" src="/lib/echarts/echarts-all.js"></script>
      <script type="text/javascript" src="../_lib/echart.js"></script>
      <script type="text/javascript" src="../_lib/My97DatePicker/WdatePicker.js"></script>
      <script type="text/javascript" src="../_lib/dateTool.js"></script>
      <script type="text/javascript">
      function decimal(num,v)  
      {  
          var vv = Math.pow(10,v);  
          return Math.round(num*vv)/vv;  
      }   

         $(function(){
        	 $("#apply6").addClass("nav_cur");
        	 $("#statMenu27").addClass("left_nav_cur");
        	 
        	 
        	 $("#timeBegin").val(GetDateStr(-10));
        	 $("#timeEnd").val(GetDateStr(1));
        	 
        	 $("#equpTypeTimeBegin").val(GetDateStr(-10));
        	 $("#equpTypeTimeEnd").val(GetDateStr(1));
        	 
        	 var checkedArray = new Array();
        	 for(var i = 1;i <= 4;i++){
        		 checkedArray.push(i);
        	 }
        	//init equipment drop list
        	 $.ajax({
     			url: '/app/deviceStatusStat/queryDevice.ac',
     			type: 'post',
     			dataType: 'json',
     			error: function(){alert('error');},
     			success:function(data){
     				if(null != data && null != data.deviceItemList){
     					var device = data.deviceItemList;
     					var option = "";
     					for(var i = 0 ;i < device.length;i++){
     						option +=  "<span id="+device[i].deviceId+">"+ device[i].deviceName;
     						option +=  "</span>";
     					}
     					$("#equip").html(option);
     					oSystem.select_sub();
     				}
     			}
     		});
        	
        	//basic status search
         	$("#basicSearch").click(function(){
         		var params = {
         				deviceId : $("#equitId").val(),
         				timeBegin: $("#timeBegin").val(),
         				timeEnd:   $("#timeEnd").val()
         		};
         		$.post('/app/deviceStatusStat/queryDeviceErrorStat.ac',params,function(data){
         			$("#totalErrorTime").text(decimal(data.deviceWorkTimeItem.totalErrorTime,2));
     				$("#errorRate").text(decimal(data.deviceWorkTimeItem.errorRate,2));
     				$("#mttr").text(decimal(data.deviceWorkTimeItem.mttr,2));
     				$("#mtbf").text(decimal(data.deviceWorkTimeItem.mtbf,2));
         		});
         	});
        	
        	//top10
        	$("#malfunction").click(function(){
        		$("#productLine1").hide();
        		$("#productLine2").hide();
        		$("#equiMalfunctionChart").show();
        		
        		$("#deviceType1").text("设备");
        		$("#titleId").text("设备故障TOP 10");
        		
        		$(".contrast").hide();
  				$("#totalErrorTimeChart").hide();
      			$("#errorRateChart").hide();
      			$("#mttrChart").hide();
      			$("#mtbfChart").hide();
        		var equpParams = {
        				deviceId : $("#equitId").val(),
        				timeBegin  : $("#timeBegin").val(),	
        				timeEnd    : $("#timeEnd").val()
        		};
        		$("#pouBegin").text(equpParams.timeBegin);
                $("#pouEnd").text(equpParams.timeEnd);
        		var equiMalfunctionChart = echarts.init(document.getElementById("equiMalfunctionChart"));
        		$.post('/app/deviceStatusStat/queryDeviceTopTenError.ac',equpParams,function(data){
        			var arryX = new Array();
        			var timeArryY = new Array();
        			$.each(data.deviceWorkTimeList,function(i,info){
        				arryX.push(info.errorCode);
        				timeArryY.push(info.errorCount);
        			});
        			$("#deviceNameId1").text(data.deviceName);
        			chartsTool(equiMalfunctionChart,"",arryX,timeArryY);
        			
        		});
        	});
        	
        	 // init equipment type drop list from json file
        	$.getJSON("../_lib/equpType.json",function(data){
        		var option = "<span id='-1'>设备类型</span>";
        		$.each(data,function(infoIndex,info){
        			option += "<span id="+info["id"]+">" + info["name"];
        			option += "</span>";
        		});
        		$(".sub_pop_EqupType").html(option);
        		
        	});
        	// 全选复选框
            $("#allChkY").click(function(){
            	checkedArray = new Array();
            	var chkStr = "#Chk";
            	for(var i = 1;i <= 4;i++){
            		$(chkStr+i+"Y").hide();
            		$(chkStr+i+"N").show();
            		if(checkedArray.indexOf(i) != -1){
            			checkedArray.splice($.inArray(i,checkedArray),1);
            		}
            	}
            	$("#allChkY").hide();
            	$("#allChkN").show();
            });
            $("#allChkN").click(function(){
            	var chkStr = "#Chk";
            	for(var i = 1;i <= 4;i++){
            		$(chkStr+i+"N").hide();
            		$(chkStr+i+"Y").show();
            		if(checkedArray.indexOf(i) < 0){
            			checkedArray.push(i);
            		}
            	}
            	$("#allChkN").hide();
            	$("#allChkY").show();
            });
            //选择复选框
            $(document).click(function(){
            	var checkedId = event.srcElement.id;
            	var checkStr = "#Chk";
            	if(checkedId.indexOf("Chk") != -1){
            		for(var i = 1 ; i <= 4 ; i++){
                		if(checkedId == ("Chk"+i+"Y")){
                			$(checkStr+i+"Y").hide();
                			$(checkStr+i+"N").show();
                			$("#allChkY").hide();
                      		$("#allChkN").show();
                      		checkedArray.splice($.inArray(i,checkedArray),1);
                		}else if(checkedId == ("Chk"+i+"N")){
                			$(checkStr+i+"N").hide();
                			$(checkStr+i+"Y").show();
                			checkedArray.push(i);
                		}
                		
                	}
                	if(checkedArray.length == 4){
                		$("#allChkN").hide();
                  		$("#allChkY").show();
                	}
            	}
            	
            	
            });
        	 // chart
        	 $("#equpType").click(function(){
        		 $("#productLine1").hide();
        		 $("#productLine2").hide();
        		 $("#deviceType1").text("设备种类");
        		 $("#titleId").text("故障设备状态对比");
        		 var equpParams = {
         				deviceType : $("#equipTypeId").val(),
         				timeBegin  : $("#equpTypeTimeBegin").val(),	
         				timeEnd    : $("#equpTypeTimeEnd").val()
         		};
        		 
        		 $.getJSON("../_lib/equpType.json",function(data){
             		$.each(data,function(infoIndex,info){
             			if(info["id"] == equpParams.deviceType){
              				$("#deviceNameId1").text(info["name"]);
              			}
             		});
             	});
        		 
        		 $("#pouBegin").text(equpParams.timeBegin);
                 $("#pouEnd").text(equpParams.timeEnd);
        		 
         		var totalErrorTimeChart = echarts.init(document.getElementById("totalErrorTimeChart")); 
         		var errorRateChart = echarts.init(document.getElementById("errorRateChart")); 
         		var mttrChart = echarts.init(document.getElementById("mttrChart"));
         		var mtbfChart = echarts.init(document.getElementById("mtbfChart"));
         		$.post('/app/deviceStatusStat/queryDeviceTypeErrorStat.ac',equpParams,function(data){
         			var arryX = new Array();
         			var totalErrorTimeArryY = new Array();
         			var errorRateArryY = new Array();
         			var mttrArryY = new Array();
         			var mtbfArryY = new Array();
         			
         			$.each(data.deviceWorkTimeList,function(i,info){
         				arryX.push(info.deviceName);
         				totalErrorTimeArryY.push(info.totalErrorTime);
         				errorRateArryY.push(info.errorRate);
         				mttrArryY.push(info.mttr);
         				mtbfArryY.push(info.mtbf);
         			});
         			if(checkedArray.length == 4 || $("#allChkN").is(":hidden")){
         				$("#equiMalfunctionChart").hide();
         				$("#totalErrorTimeChart").show();
             			$("#errorRateChart").show();
             			$("#mttrChart").show();
             			$("#mtbfChart").show();
         				chartsTool(totalErrorTimeChart,"故障总时间",arryX,totalErrorTimeArryY);
         				chartsTool(errorRateChart,"故障率",arryX,errorRateArryY);
         				chartsTool(mttrChart,"MTTR",arryX,mttrArryY);
         				chartsTool(mtbfChart,"MTBF",arryX,mtbfArryY);
         			}else{
         				if(checkedArray.indexOf(1) != -1){
         					$("#totalErrorTimeChart").show();
         					chartsTool(totalErrorTimeChart,"故障总时间",arryX,totalErrorTimeArryY);
         				}else{
         					$("#totalRuntimeChart").hide();
         				}
         				if(checkedArray.indexOf(2) != -1){
         					$("#errorRateChart").show();
         					chartsTool(errorRateChart,"故障率",arryX,errorRateArryY);
         				}else{
         					$("#errorRateChart").hide();
         				}
         				if(checkedArray.indexOf(3) != -1){
         					$("#mttrChart").show();
         					chartsTool(mttrChart,"MTTR",arryX,mttrArryY);
         				}else{
         					$("#mttrChart").hide();
         				}
         				if(checkedArray.indexOf(4) != -1){
         					$("#mtbfChart").show();
         					chartsTool(mtbfChart,"MTBF",arryX,mtbfArryY);
         				}else{
         					$("#mtbfChart").hide();
         				}
         			}
         			
         			
         		});
        		 
        	 });
        	
             //导出设备状态对比数据
         	$("#export").click(function(){
         		window.location.href= '/app/deviceStatusStat/queryDeviceTypeErrorStatExport.ac?deviceType='+$("#equipTypeId").val()
         				+'&timeBegin='+$("#equpTypeTimeBegin").val() + '&timeEnd=' + $("#equpTypeTimeEnd").val();
         		
         	});
        
         });
      </script>

  </head>
  <body>
  <!--top start-->
     #parse("/app/header.vm")
  <!--top end-->
  <!--main start-->
  <div class="main">
      <div class="left fl">
           <!-- left menu start -->
          #parse("/app/newmenu.vm")
          <!-- left menu end -->
          <div class="left_r fr">
              <div class="location">后处理单元 > <span>设备故障统计</span></div>
              <div class="basic_query clearfix">
                  <h4 class="basic_t">基本故障查询</h4>
                  <div class="basic_c" style="width: 700px;">
                      <div class="basic_select">
                          <span class="basic_val">生产线</span>
                          <i class="fa fa-angle-down"></i>
                          <div class="sub_pop">
                              <span>生产线1</span>
                              <span>生产线2</span>
                              <span>生产线3</span>
                          </div>
                      </div>
                      <div class="basic_select">
                          <span class="basic_val">设备</span>
                          <input type="hidden" value="" id="equitId">
                          <i class="fa fa-angle-down"></i>
                          <div class="sub_pop" id="equip">
                          </div>
                      </div>

                      <div class="date">
                          <span class="date_t">日期选择</span>
                          <input type="text" class="date_wrap tcalInput" onfocus="WdatePicker();" id="timeBegin" />
                              <!--<span>2016-08-15</span>
                              <i class="fa fa-calendar"></i>-->
                          <span class="zhi">到</span>
                          <input type="text" class="date_wrap tcalInput" onfocus="WdatePicker();" id="timeEnd"/>
                          <!--<div class="date_wrap">
                              <span>2016-08-15</span>
                              <i class="fa fa-calendar"></i>
                          </div>-->
                      </div>
                  </div>
                  <div class="search"><span class="search_btn" id="basicSearch">查询</span> </div>
                  <div class="search_result malfunction" style="width: 570px">
                      <ul class="result_list">
                          <li>
                              <span><font id="totalErrorTime">0</font><em>min</em></span>
                              <strong>故障总时间</strong>
                          </li>
                          <li>
                              <span><font id="errorRate">0</font><em>%</em></span>
                              <strong>故障率</strong>
                          </li>
                          <li>
                              <span><font id="mttr">0</font><em>min</em></span>
                              <strong>MTTR</strong>
                          </li>
                          <li>
                              <span><font id="mtbf">0</font><em>min</em></span>
                              <strong>MTBF</strong>
                          </li>
                      </ul>
                  </div>
                  <div class="top10" style="width: 20px;">
                      <span class="pop_btn malfunction_btn" id="malfunction">故障种类<br/>TOP 10</span>
                  </div>

              </div>
              <!--设备状态对比 start-->
              <div class="basic_query">
                  <h4 class="basic_t">设备状态对比</h4>
                  <div class="basic_c">
                      <div class="basic_select_EqupType">
                          <span class="basic_val_EqupType">设备类型</span>
                          <input type="hidden" id="equipTypeId" value=""/>
                          <i class="fa fa-angle-down"></i>
                          <div class="sub_pop_EqupType">
                              
                          </div>
                      </div>

                      <div class="date">
                          <span class="date_t">日期选择</span>
                          <input type="text" class="date_wrap tcalInput" onfocus="WdatePicker();" id="equpTypeTimeBegin" />
                          <!--<span>2016-08-15</span>
                          <i class="fa fa-calendar"></i>-->
                          <span class="zhi">到</span>
                          <input type="text" class="date_wrap tcalInput" onfocus="WdatePicker();" id="equpTypeTimeEnd" />
                          <!--<div class="date_wrap">
                              <span>2016-08-15</span>
                              <i class="fa fa-calendar"></i>
                          </div>-->
                      </div>
                  </div>
                  <div class="item clearfix">
                      <div class="item_l">对比项</div>
                      <div class="item_r">
                          <div class="item_r_t">
                              <i class="fa fa-check-square" id="allChkY"></i>
                              <i class="fa fa-square-o" id="allChkN" style="display: none"></i>
                              <span>以下全选</span>
                          </div>
                          <div class="item_r_b">
                              <i class="fa fa-check-square" id="Chk1Y"></i>
                              <i class="fa fa-square-o" id="Chk1N" style="display: none"></i>
                              <span>故障总时间</span>
                              <i class="fa fa-check-square" id="Chk2Y"></i>
                              <i class="fa fa-square-o" id="Chk2N" style="display: none"></i>
                              <span>故障率</span>
                              <i class="fa fa-check-square" id="Chk3Y"></i>
                              <i class="fa fa-square-o" id="Chk3N" style="display: none"></i>
                              <span>MTTR</span>
                              <i class="fa fa-check-square" id="Chk4Y"></i>
                              <i class="fa fa-square-o" id="Chk4N" style="display: none"></i>
                              <span>MTBF</span>
                          </div>
                      </div>
                  </div>
                  <div class="search"><span class="search_btn pop_btn" id="equpType">查询</span> </div>
              </div>
              <!--设备状态对比 end-->

          </div>
      </div>
      <div class="right fr">
          <h4 class="help">帮助</h4>
          <ul class="help_list">
              <li><a href="#">该页面用来统计设备故障信息</a></li>
              
          </ul>
      </div>
  </div>

  <!--main end-->

  <!--popUp 弹出层  设备故障TOP 10弹出层 start-->
  <div id="mask"></div>
  <div class="popUp">
      <div class="popUp_t"><font id="titleId">设备故障TOP 10</font><div class="close_t"><i class="fa fa-close"></i> </div> </div>
      <div class="popUp_c">
          <div class="popUp_c_t clearfix">
              <div class="popUp_c_l">
                  <div class="category" style="width: 800px;">
                      <label class="cate Top_10" id="productLine1">生产线</label>
                      <span id="productLine2">A线</span>
                      <label class="cate Top_10 Top_10_01" id="deviceType1">设备种类</label>
                      <span id="deviceNameId1"></span>
                      <em>日期</em>
                      <span id="pouBegin"></span>
                      <em>到</em>
                      <span id="pouEnd"></span>
                  </div>
                  <div class="contrast">
                      <label class="contrast_t contrast_t_01">对比项</label>
                      <i class="fa fa-check-square"></i>
                      <span>故障总时间</span>
                      <i class="fa fa-check-square"></i>
                      <span>故障率</span>
                      <i class="fa fa-check-square"></i>
                      <span>MTTR</span>
                      <i class="fa fa-check-square"></i>
                      <span>MTBF</span>
                  </div>
              </div>
              <div class="popUp_c_t_r fr" style="margin-bottom: 5px;margin-top: -25px;">
                  <a class="export"  id="export" style="padding:0 10px;">数据导出</a>
              </div>
          </div>
          <div class="line"></div>
          <div class="popUp_c_c">
              <div id="equiMalfunctionChart" style="height: 400px;width: 100%;"></div>
              <div id="totalErrorTimeChart" style="display:none;height: 300px;width: 475px;float: left;"></div>
              <div id="errorRateChart" style="display:none;height: 300px;width: 475px;float: right;"></div>
              <div id="mttrChart" style="display:none;height: 300px;width: 475px;float: left;"></div>
              <div id="mtbfChart" style="display:none;height: 300px;width: 475px;float: right;"></div>
              
          </div>
      </div>
  </div>
  <!--popUp 弹出层 设备故障对比结果弹出层 end-->

  </body>
</html>